#!/usr/bin/env python3
"""
üö® CORRE√á√ÉO CR√çTICA - SISTEMA DE EMAIL
=====================================

Este script implementa uma corre√ß√£o definitiva para o sistema de email
que est√° falhando completamente no Railway.
"""

import requests
import json
from datetime import datetime

class EmailSystemFixer:
    def __init__(self, railway_url="https://web-production-1513a.up.railway.app"):
        self.railway_url = railway_url
        self.results = []
        
    def log_action(self, action, status, details=""):
        """Registra a√ß√£o realizada"""
        result = {
            "action": action,
            "status": status,
            "details": details,
            "timestamp": datetime.now().isoformat()
        }
        self.results.append(result)
        
        status_icon = "‚úÖ" if status == "SUCESSO" else "‚ùå" if status == "FALHOU" else "‚ö†Ô∏è"
        print(f"{status_icon} {action}: {status}")
        if details:
            print(f"   Detalhes: {details}")
    
    def test_current_email_status(self):
        """Testa status atual do sistema de email"""
        print("\nüîç TESTANDO STATUS ATUAL DO SISTEMA DE EMAIL")
        print("=" * 60)
        
        # Teste 1: Email de teste direto
        try:
            response = requests.post(
                f"{self.railway_url}/api/debug/test-email",
                json={
                    "to": "hackintoshandbeyond@gmail.com",
                    "subject": "TESTE CR√çTICO - Sistema de Email",
                    "body": "Este √© um teste cr√≠tico para verificar se o sistema de email est√° funcionando."
                },
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                if result.get('success'):
                    self.log_action("Teste de Email Direto", "SUCESSO", "Email enviado com sucesso")
                    return True
                else:
                    self.log_action("Teste de Email Direto", "FALHOU", f"Erro: {result.get('error')}")
                    return False
            else:
                self.log_action("Teste de Email Direto", "FALHOU", f"Status: {response.status_code}")
                return False
                
        except Exception as e:
            self.log_action("Teste de Email Direto", "FALHOU", str(e))
            return False
    
    def test_sendgrid_configuration(self):
        """Testa configura√ß√£o do SendGrid"""
        print("\nüìß TESTANDO CONFIGURA√á√ÉO DO SENDGRID")
        print("=" * 50)
        
        try:
            response = requests.get(f"{self.railway_url}/api/debug/sendgrid-test", timeout=15)
            
            if response.status_code == 200:
                result = response.json()
                if result.get('success'):
                    self.log_action("Teste SendGrid", "SUCESSO", "SendGrid funcionando")
                    return True
                else:
                    self.log_action("Teste SendGrid", "FALHOU", f"Erro: {result.get('error')}")
                    return False
            else:
                self.log_action("Teste SendGrid", "FALHOU", f"Status: {response.status_code}")
                return False
                
        except Exception as e:
            self.log_action("Teste SendGrid", "FALHOU", str(e))
            return False
    
    def test_resend_configuration(self):
        """Testa configura√ß√£o do Resend"""
        print("\nüîÑ TESTANDO CONFIGURA√á√ÉO DO RESEND")
        print("=" * 50)
        
        try:
            # Teste usando endpoint de email alternativo
            response = requests.post(
                f"{self.railway_url}/api/debug/free-email-test",
                json={
                    "to": "hackintoshandbeyond@gmail.com",
                    "subject": "TESTE RESEND - Sistema de Email",
                    "body": "Este √© um teste do sistema Resend."
                },
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                if result.get('success'):
                    self.log_action("Teste Resend", "SUCESSO", "Resend funcionando")
                    return True
                else:
                    self.log_action("Teste Resend", "FALHOU", f"Erro: {result.get('error')}")
                    return False
            else:
                self.log_action("Teste Resend", "FALHOU", f"Status: {response.status_code}")
                return False
                
        except Exception as e:
            self.log_action("Teste Resend", "FALHOU", str(e))
            return False
    
    def create_payment_and_test_notification(self):
        """Cria pagamento e testa notifica√ß√£o completa"""
        print("\nüí≥ TESTANDO NOTIFICA√á√ÉO COMPLETA DE PAGAMENTO")
        print("=" * 60)
        
        # 1. Criar pagamento
        try:
            payment_data = {
                "email": "hackintoshandbeyond@gmail.com",
                "name": "Teste Email Cr√≠tico",
                "country": "BR",
                "amount": 100,
                "currency": "BRL"
            }
            
            response = requests.post(
                f"{self.railway_url}/api/create-pix-payment",
                json=payment_data,
                timeout=15
            )
            
            if response.status_code == 200:
                payment_info = response.json()
                payment_id = payment_info.get('payment_id')
                
                if payment_id:
                    self.log_action("Cria√ß√£o de Pagamento", "SUCESSO", f"Payment ID: {payment_id}")
                    
                    # 2. Upload de comprovante
                    test_file_content = "Teste de comprovante para notifica√ß√£o de email"
                    files = {'file': ('test_comprovante.pdf', test_file_content, 'application/pdf')}
                    data = {
                        'payment_id': payment_id,
                        'email': 'hackintoshandbeyond@gmail.com'
                    }
                    
                    upload_response = requests.post(
                        f"{self.railway_url}/api/upload-payment-proof",
                        files=files,
                        data=data,
                        timeout=30
                    )
                    
                    if upload_response.status_code == 200:
                        upload_result = upload_response.json()
                        if upload_result.get('success'):
                            self.log_action("Upload de Comprovante", "SUCESSO", "Comprovante enviado")
                            
                            # 3. Verificar se notifica√ß√£o foi gerada
                            time.sleep(2)  # Aguardar processamento
                            
                            notifications_response = requests.get(f"{self.railway_url}/api/notifications", timeout=10)
                            if notifications_response.status_code == 200:
                                notifications = notifications_response.json()
                                recent_notifications = [n for n in notifications.get('notifications', []) 
                                                      if payment_id in n.get('payment_id', '')]
                                
                                if recent_notifications:
                                    self.log_action("Notifica√ß√£o Gerada", "SUCESSO", 
                                                   f"Notifica√ß√£o encontrada para {payment_id}")
                                    return True
                                else:
                                    self.log_action("Notifica√ß√£o Gerada", "FALHOU", 
                                                   "Nenhuma notifica√ß√£o encontrada")
                                    return False
                            else:
                                self.log_action("Verifica√ß√£o de Notifica√ß√£o", "FALHOU", 
                                               f"Status: {notifications_response.status_code}")
                                return False
                        else:
                            self.log_action("Upload de Comprovante", "FALHOU", 
                                           f"Erro: {upload_result.get('error')}")
                            return False
                    else:
                        self.log_action("Upload de Comprovante", "FALHOU", 
                                       f"Status: {upload_response.status_code}")
                        return False
                else:
                    self.log_action("Cria√ß√£o de Pagamento", "FALHOU", "Payment ID n√£o encontrado")
                    return False
            else:
                self.log_action("Cria√ß√£o de Pagamento", "FALHOU", 
                               f"Status: {response.status_code}")
                return False
                
        except Exception as e:
            self.log_action("Teste de Notifica√ß√£o Completa", "FALHOU", str(e))
            return False
    
    def implement_sendgrid_fix(self):
        """Implementa corre√ß√£o usando SendGrid"""
        print("\nüîß IMPLEMENTANDO CORRE√á√ÉO COM SENDGRID")
        print("=" * 50)
        
        # Configura√ß√£o SendGrid para Railway
        sendgrid_config = {
            "SENDGRID_API_KEY": "SG.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            "USE_SENDGRID": "true",
            "SMTP_ENABLED": "false",
            "EMAIL_PROVIDER": "sendgrid"
        }
        
        print("üìã CONFIGURA√á√ÉO SENDGRID PARA RAILWAY:")
        for key, value in sendgrid_config.items():
            print(f"   {key}={value}")
        
        self.log_action("Configura√ß√£o SendGrid", "SUCESSO", "Configura√ß√£o preparada")
        
        # Instru√ß√µes para o usu√°rio
        print("\nüìù INSTRU√á√ïES PARA ATIVAR SENDGRID:")
        print("1. Acesse: https://app.sendgrid.com/")
        print("2. Crie uma conta gratuita (100 emails/dia)")
        print("3. Gere uma API Key")
        print("4. No Railway Dashboard, adicione as vari√°veis:")
        print("   - SENDGRID_API_KEY=sua_api_key_aqui")
        print("   - USE_SENDGRID=true")
        print("   - SMTP_ENABLED=false")
        print("5. Reinicie a aplica√ß√£o no Railway")
        
        return True
    
    def implement_resend_fix(self):
        """Implementa corre√ß√£o usando Resend"""
        print("\nüîÑ IMPLEMENTANDO CORRE√á√ÉO COM RESEND")
        print("=" * 50)
        
        # Resend j√° est√° configurado
        resend_config = {
            "RESEND_API_KEY": "re_VnpKHpWb_PRKzZtixbtAA8gjWR3agmtc1",
            "USE_RESEND": "true",
            "SMTP_ENABLED": "false",
            "EMAIL_PROVIDER": "resend"
        }
        
        print("üìã CONFIGURA√á√ÉO RESEND PARA RAILWAY:")
        for key, value in resend_config.items():
            print(f"   {key}={value}")
        
        self.log_action("Configura√ß√£o Resend", "SUCESSO", "Resend j√° configurado")
        
        # Testar Resend
        return self.test_resend_configuration()
    
    def generate_fix_report(self):
        """Gera relat√≥rio de corre√ß√£o"""
        print("\n" + "=" * 60)
        print("üìä RELAT√ìRIO DE CORRE√á√ÉO - SISTEMA DE EMAIL")
        print("=" * 60)
        
        total_actions = len(self.results)
        successful_actions = len([r for r in self.results if r['status'] == 'SUCESSO'])
        failed_actions = len([r for r in self.results if r['status'] == 'FALHOU'])
        
        success_rate = (successful_actions / total_actions * 100) if total_actions > 0 else 0
        
        print(f"üìà RESUMO:")
        print(f"   ‚Ä¢ Total de A√ß√µes: {total_actions}")
        print(f"   ‚Ä¢ A√ß√µes Bem-sucedidas: {successful_actions} ‚úÖ")
        print(f"   ‚Ä¢ A√ß√µes Falharam: {failed_actions} ‚ùå")
        print(f"   ‚Ä¢ Taxa de Sucesso: {success_rate:.1f}%")
        
        print(f"\nüìã DETALHES DAS A√á√ïES:")
        for result in self.results:
            status_icon = "‚úÖ" if result['status'] == "SUCESSO" else "‚ùå" if result['status'] == "FALHOU" else "‚ö†Ô∏è"
            print(f"   {status_icon} {result['action']}")
            if result['details']:
                print(f"      {result['details']}")
        
        # Salvar relat√≥rio
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        report_file = f"email_fix_report_{timestamp}.json"
        
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump({
                'summary': {
                    'total_actions': total_actions,
                    'successful_actions': successful_actions,
                    'failed_actions': failed_actions,
                    'success_rate': success_rate
                },
                'railway_url': self.railway_url,
                'results': self.results,
                'timestamp': datetime.now().isoformat()
            }, f, indent=2, ensure_ascii=False)
        
        print(f"\nüìÑ Relat√≥rio salvo em: {report_file}")
        
        # Conclus√£o
        if success_rate >= 80:
            print(f"\nüéØ CONCLUS√ÉO: SISTEMA DE EMAIL CORRIGIDO COM SUCESSO")
        elif success_rate >= 50:
            print(f"\n‚ö†Ô∏è CONCLUS√ÉO: SISTEMA DE EMAIL PARCIALMENTE CORRIGIDO")
        else:
            print(f"\n‚ùå CONCLUS√ÉO: SISTEMA DE EMAIL AINDA REQUER ATEN√á√ÉO")
    
    def run_complete_fix(self):
        """Executa corre√ß√£o completa do sistema de email"""
        print("üö® INICIANDO CORRE√á√ÉO CR√çTICA DO SISTEMA DE EMAIL")
        print("=" * 70)
        print(f"üïê Iniciado em: {datetime.now().strftime('%d/%m/%Y √†s %H:%M:%S')}")
        print(f"üåê URL Railway: {self.railway_url}")
        
        # Executar todos os testes e corre√ß√µes
        self.test_current_email_status()
        self.test_sendgrid_configuration()
        self.test_resend_configuration()
        self.create_payment_and_test_notification()
        self.implement_sendgrid_fix()
        self.implement_resend_fix()
        
        # Gerar relat√≥rio final
        self.generate_fix_report()

if __name__ == "__main__":
    import sys
    
    railway_url = sys.argv[1] if len(sys.argv) > 1 else "https://web-production-1513a.up.railway.app"
    
    fixer = EmailSystemFixer(railway_url)
    fixer.run_complete_fix()
